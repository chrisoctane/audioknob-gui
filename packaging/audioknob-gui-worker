#!/usr/bin/env python3
"""Root worker launcher.

Intended install location:
  /usr/libexec/audioknob-gui-worker

This must be runnable by root via pkexec.
For development, set AUDIOKNOB_DEV_REPO env var to the repo path.
For production, install the package system-wide.
"""

from __future__ import annotations

import os
import sys
from pathlib import Path

# For development: add repo root to path so we can import audioknob_gui
# Set AUDIOKNOB_DEV_REPO=/path/to/repo for dev mode
_DEV_REPO_PATH = os.environ.get("AUDIOKNOB_DEV_REPO", "")
if not _DEV_REPO_PATH:
    dev_conf = Path("/etc/audioknob-gui/dev.conf")
    if dev_conf.exists():
        try:
            _DEV_REPO_PATH = dev_conf.read_text().splitlines()[0].strip()
        except OSError:
            _DEV_REPO_PATH = ""
if _DEV_REPO_PATH:
    dev_repo = Path(_DEV_REPO_PATH)
    if dev_repo.exists():
        sys.path.insert(0, str(dev_repo))


def main() -> int:
    try:
        from audioknob_gui.worker.cli import main as worker_main
    except Exception as e:
        print(
            "audioknob-gui worker is not installed system-wide.\n"
            "Install this project into system python (or package it) so root can import it.\n\n"
            f"Import error: {e}",
            file=sys.stderr,
        )
        return 2

    return int(worker_main())


if __name__ == "__main__":
    raise SystemExit(main())
