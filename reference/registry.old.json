{
  "schema_version": 1,
  "knobs": [
    {
      "id": "rt_limits_audio_group",
      "title": "Realtime limits for @audio (rtprio/memlock/nice)",
      "description": "Allows pro-audio apps to use realtime priority and lock memory (recommended for JACK/PipeWire pro-audio).",
      "category": "permissions",
      "risk_level": "low",
      "requires_root": true,
      "requires_reboot": false,
      "distro_support": {
        "default": {
          "limits_file": "/etc/security/limits.d/99-audio.conf",
          "audio_group": "audio"
        }
      },
      "read": {
        "files": [
          "/etc/security/limits.d/99-audio.conf",
          "/etc/security/limits.conf"
        ]
      },
      "apply": {
        "type": "file.ensure_lines",
        "target": "${limits_file}",
        "mode": "0644",
        "owner": "root",
        "group": "root",
        "lines": [
          "@${audio_group} - rtprio 95",
          "@${audio_group} - memlock unlimited",
          "@${audio_group} - nice -10"
        ]
      },
      "verify": {
        "commands": [
          "sh -lc 'getent group ${audio_group} >/dev/null 2>&1 && echo ok:group || echo warn:group_missing'"
        ]
      }
    },
    {
      "id": "irqbalance_disable",
      "title": "Disable irqbalance service",
      "description": "Stops automatic IRQ rebalancing so audio IRQ pinning and priorities stay stable.",
      "category": "irq",
      "risk_level": "low",
      "requires_root": true,
      "requires_reboot": false,
      "distro_support": {
        "default": {
          "unit": "irqbalance.service"
        }
      },
      "read": {
        "commands": [
          "sh -lc 'systemctl is-enabled ${unit} 2>/dev/null || true'",
          "sh -lc 'systemctl is-active ${unit} 2>/dev/null || true'"
        ]
      },
      "apply": {
        "type": "systemd.disable_now",
        "unit": "${unit}"
      },
      "verify": {
        "commands": [
          "sh -lc '! systemctl is-active --quiet ${unit} && echo ok:inactive || echo warn:still_active'"
        ]
      }
    },
    {
      "id": "rtirq_enable_and_config",
      "title": "Enable rtirq and set audio-first priority list",
      "description": "Raises priority of audio-related IRQ threads so audio interrupts are serviced first (reduces xruns).",
      "category": "irq",
      "risk_level": "medium",
      "requires_root": true,
      "requires_reboot": false,
      "distro_support": {
        "opensuse": {
          "config_file": "/etc/rtirq.conf",
          "unit": "rtirq.service"
        },
        "debian": {
          "config_file": "/etc/default/rtirq",
          "unit": "rtirq.service"
        },
        "fedora": {
          "config_file": "/etc/sysconfig/rtirq",
          "unit": "rtirq.service"
        },
        "default": {
          "config_file": "/etc/rtirq.conf",
          "unit": "rtirq.service"
        }
      },
      "read": {
        "files": [
          "${config_file}"
        ],
        "commands": [
          "sh -lc 'systemctl is-enabled ${unit} 2>/dev/null || true'",
          "sh -lc 'systemctl is-active ${unit} 2>/dev/null || true'"
        ]
      },
      "apply": {
        "type": "file.ensure_kv_shellstyle",
        "target": "${config_file}",
        "mode": "0644",
        "owner": "root",
        "group": "root",
        "kv": {
          "RTIRQ_NAME_LIST": "\"snd xhci usb ehci\"",
          "RTIRQ_PRIO_HIGH": "90",
          "RTIRQ_PRIO_DECR": "5",
          "RTIRQ_PRIO_LOW": "51"
        },
        "post": [
          {
            "type": "systemd.enable_now",
            "unit": "${unit}"
          }
        ]
      },
      "verify": {
        "commands": [
          "sh -lc 'systemctl is-active --quiet ${unit} && echo ok:active || echo warn:not_active'"
        ]
      }
    },
    {
      "id": "cpu_governor_performance_temporary",
      "title": "Set CPU governor to performance (temporary)",
      "description": "Sets CPU frequency scaling governor to performance for more consistent low-latency behavior (until changed/reboot).",
      "category": "power",
      "risk_level": "low",
      "requires_root": true,
      "requires_reboot": false,
      "distro_support": {
        "default": {
          "glob": "/sys/devices/system/cpu/cpu*/cpufreq/scaling_governor"
        }
      },
      "read": {
        "commands": [
          "sh -lc 'head -n 1 /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || true'"
        ]
      },
      "apply": {
        "type": "sysfs.write_glob",
        "glob": "${glob}",
        "value": "performance"
      },
      "verify": {
        "commands": [
          "sh -lc 'test -e /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor && grep -qx performance /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor && echo ok:performance || echo warn:unknown'"
        ]
      }
    },
    {
      "id": "cpu_governor_performance_persistent",
      "title": "Set CPU governor to performance (persistent via cpupower)",
      "description": "Configures cpupower to keep the CPU governor in performance mode across reboots.",
      "category": "power",
      "risk_level": "medium",
      "requires_root": true,
      "requires_reboot": false,
      "distro_support": {
        "opensuse": {
          "unit": "cpupower.service",
          "config_file": "/etc/sysconfig/cpupower",
          "config_key": "CPUPOWER_START_OPTS"
        },
        "fedora": {
          "unit": "cpupower.service",
          "config_file": "/etc/sysconfig/cpupower",
          "config_key": "CPUPOWER_START_OPTS"
        },
        "debian": {
          "unit": "cpupower.service",
          "config_file": "/etc/default/cpupower",
          "config_key": "GOVERNOR"
        },
        "default": {
          "unit": "cpupower.service",
          "config_file": "/etc/sysconfig/cpupower",
          "config_key": "CPUPOWER_START_OPTS"
        }
      },
      "read": {
        "files": [
          "${config_file}"
        ],
        "commands": [
          "sh -lc 'systemctl is-enabled ${unit} 2>/dev/null || true'"
        ]
      },
      "apply": {
        "type": "platform.cpupower_config_performance",
        "unit": "${unit}",
        "config_file": "${config_file}",
        "config_key": "${config_key}"
      },
      "verify": {
        "commands": [
          "sh -lc 'systemctl is-enabled --quiet ${unit} && echo ok:enabled || echo warn:not_enabled'"
        ]
      }
    }
  ]
}
